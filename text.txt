CREATE TABLE users (
  id             UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username       TEXT UNIQUE NOT NULL,
  password_hash  TEXT NOT NULL,
  full_name      TEXT NOT NULL,
  role           TEXT NOT NULL CHECK (role IN ('admin', 'manager', 'waiter', 'cashier', 'kitchen')),
  is_active      BOOLEAN NOT NULL DEFAULT TRUE,
  created_at     TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at     TIMESTAMP NOT NULL DEFAULT NOW()
);



CREATE TABLE dining_tables (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name          TEXT NOT NULL,        -- e.g. "T1", "Booth 3"
  area          TEXT,                 -- e.g. "Terrace", "Main Hall"
  is_active     BOOLEAN NOT NULL DEFAULT TRUE,
  created_at    TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at    TIMESTAMP NOT NULL DEFAULT NOW()
);

///////////////////

CREATE TABLE menu_categories (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name        TEXT NOT NULL,       -- e.g. "Pizza", "Drinks"
  sort_order  INT NOT NULL DEFAULT 0,
  created_at  TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at  TIMESTAMP NOT NULL DEFAULT NOW()
);



CREATE TABLE menu_items (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category_id     UUID NOT NULL REFERENCES menu_categories(id),
  name            TEXT NOT NULL,
  description     TEXT,
  base_price      NUMERIC(10,2) NOT NULL,
  is_active       BOOLEAN NOT NULL DEFAULT TRUE,
  sku             TEXT,             -- optional for inventory
  created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE modifier_groups (
  id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name         TEXT NOT NULL,          -- "Toppings", "Sauces"
  min_select   INT NOT NULL DEFAULT 0,
  max_select   INT,                    -- NULL = no max
  created_at   TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at   TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE modifiers (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  modifier_group_id     UUID NOT NULL REFERENCES modifier_groups(id),
  name                  TEXT NOT NULL,   -- "Extra Cheese"
  extra_price           NUMERIC(10,2) NOT NULL DEFAULT 0,
  is_active             BOOLEAN NOT NULL DEFAULT TRUE,
  created_at            TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at            TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Link menu items to modifier groups
CREATE TABLE menu_item_modifier_groups (
  menu_item_id      UUID NOT NULL REFERENCES menu_items(id),
  modifier_group_id UUID NOT NULL REFERENCES modifier_groups(id),
  PRIMARY KEY (menu_item_id, modifier_group_id)
);

////////////////////////

CREATE TABLE orders (
  id                 UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_number       BIGSERIAL UNIQUE, -- human readable incremental
  dining_table_id    UUID REFERENCES dining_tables(id),
  status             TEXT NOT NULL CHECK (status IN (
                        'open', 'sent_to_kitchen', 'served', 'paid', 'void'
                      )),
  type               TEXT NOT NULL CHECK (type IN ('dine_in', 'takeaway', 'delivery')),
  opened_by_user_id  UUID NOT NULL REFERENCES users(id),
  closed_by_user_id  UUID REFERENCES users(id),
  subtotal           NUMERIC(10,2) NOT NULL DEFAULT 0,
  discount_amount    NUMERIC(10,2) NOT NULL DEFAULT 0,
  tax_amount         NUMERIC(10,2) NOT NULL DEFAULT 0,
  total              NUMERIC(10,2) NOT NULL DEFAULT 0,
  notes              TEXT,
  created_at         TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at         TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE order_items (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id        UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
  menu_item_id    UUID NOT NULL REFERENCES menu_items(id),
  quantity        INT NOT NULL CHECK (quantity > 0),
  unit_price      NUMERIC(10,2) NOT NULL,
  total_price     NUMERIC(10,2) NOT NULL,
  notes           TEXT,
  status          TEXT NOT NULL CHECK (status IN ('pending', 'in_kitchen', 'ready', 'served')),
  created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMP NOT NULL DEFAULT NOW()
);


CREATE TABLE order_item_modifiers (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_item_id   UUID NOT NULL REFERENCES order_items(id) ON DELETE CASCADE,
  modifier_id     UUID NOT NULL REFERENCES modifiers(id),
  extra_price     NUMERIC(10,2) NOT NULL,
  created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);
//////////////


CREATE TABLE devices (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name          TEXT NOT NULL,    -- "POS1", "KitchenScreen1"
  type          TEXT NOT NULL CHECK (type IN ('pos', 'kitchen', 'manager')),
  api_key       TEXT UNIQUE NOT NULL,
  last_seen_at  TIMESTAMP,
  created_at    TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE sync_outbox (
  id           BIGSERIAL PRIMARY KEY,
  table_name   TEXT NOT NULL,
  record_id    UUID NOT NULL,
  operation    TEXT NOT NULL CHECK (operation IN ('insert', 'update', 'delete')),
  payload      JSONB NOT NULL,
  created_at   TIMESTAMP NOT NULL DEFAULT NOW(),
  processed_at TIMESTAMP
);


//////////////////

CREATE TABLE payments (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id        UUID NOT NULL REFERENCES orders(id),
  amount          NUMERIC(10,2) NOT NULL,
  method          TEXT NOT NULL CHECK (method IN ('cash', 'card', 'split')),
  note            TEXT,
  created_by      UUID REFERENCES users(id),
  created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);


